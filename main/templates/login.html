{% extends 'base.html' %}
{% block content %}
<div class="login-wrapper">
  <div class="login-box">
    <h2>LOGIN</h2>
    <form id="login-form">
      <input type="text" id="username" name="username" placeholder="Username" required>
      <input type="password" id="password" name="password" placeholder="Password" required>
      <button type="submit" id="login-btn">Log In</button>
    </form>
    <div id="login-error" class="error-message" style="color: #ef4444; margin-top: 10px; display: none;"></div>
    <p class="signup-text">
      Don't have an account? <a href="{% url 'main:register' %}">Sign up</a>
    </p>
  </div>
</div>

<script type="module">
  const form = document.getElementById('login-form');
  const usernameInput = document.getElementById('username');
  const passwordInput = document.getElementById('password');
  const loginBtn = document.getElementById('login-btn');
  const errorDiv = document.getElementById('login-error');

  function showError(message) {
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
  }

  function hideError() {
    errorDiv.style.display = 'none';
  }

  function setLoading(loading) {
    loginBtn.disabled = loading;
    loginBtn.textContent = loading ? 'Logging in...' : 'Log In';
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    hideError();
    setLoading(true);

    try {
      const response = await fetch('{% url "main:ajax_login" %}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          username: usernameInput.value.trim(),
          password: passwordInput.value
        })
      });

      const data = await response.json();

      if (data.success) {
        // Redirect to main page on successful login
        showToast('Welcome!', 'Login successful. Redirecting...', 'success');
        setTimeout(() => {
          window.location.href = data.redirect_url;
        }, 1000);
      } else {
        showError(data.error || 'Login failed');
      }
    } catch (error) {
      console.error('Login error:', error);
      showToast('Network Error', 'Please check your connection and try again.', 'error');
    } finally {
      setLoading(false);
    }
  });
</script>
{% endblock content %}
