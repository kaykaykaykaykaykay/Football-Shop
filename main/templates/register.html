{% extends 'base.html' %}

{% block meta %}
<title>Register</title>
{% endblock meta %}

{% block content %}
<div class="login-wrapper">
  <div class="login-box">
    <h2>REGISTER</h2>

    <form id="register-form">
      <div class="form-group">
        <label for="username">Username:</label>
        <input type="text" id="username" name="username" required>
      </div>
      <div class="form-group">
        <label for="password1">Password:</label>
        <input type="password" id="password1" name="password1" required>
      </div>
      <div class="form-group">
        <label for="password2">Confirm Password:</label>
        <input type="password" id="password2" name="password2" required>
      </div>
      <button type="submit" id="register-btn">Sign Up</button>
    </form>

    <div id="register-error" class="error-message" style="color: #ef4444; margin-top: 10px; display: none;"></div>
    <div id="register-success" class="success-message" style="color: #10b981; margin-top: 10px; display: none;"></div>

    <p class="signup-text">
      Already have an account? <a href="{% url 'main:login' %}">Log in</a>
    </p>
  </div>
</div>

<script type="module">
  const form = document.getElementById('register-form');
  const usernameInput = document.getElementById('username');
  const password1Input = document.getElementById('password1');
  const password2Input = document.getElementById('password2');
  const registerBtn = document.getElementById('register-btn');
  const errorDiv = document.getElementById('register-error');
  const successDiv = document.getElementById('register-success');

  function showError(message) {
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
    successDiv.style.display = 'none';
  }

  function showSuccess(message) {
    successDiv.textContent = message;
    successDiv.style.display = 'block';
    errorDiv.style.display = 'none';
  }

  function hideMessages() {
    errorDiv.style.display = 'none';
    successDiv.style.display = 'none';
  }

  function setLoading(loading) {
    registerBtn.disabled = loading;
    registerBtn.textContent = loading ? 'Creating Account...' : 'Sign Up';
  }

  function validateForm() {
    const username = usernameInput.value.trim();
    const password1 = password1Input.value;
    const password2 = password2Input.value;

    if (!username || !password1 || !password2) {
      showError('All fields are required');
      return false;
    }

    if (username.length < 3) {
      showError('Username must be at least 3 characters long');
      return false;
    }

    if (password1.length < 8) {
      showError('Password must be at least 8 characters long');
      return false;
    }

    if (password1 !== password2) {
      showError('Passwords do not match');
      return false;
    }

    return true;
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    hideMessages();

    if (!validateForm()) {
      return;
    }

    setLoading(true);

    try {
      const response = await fetch('{% url "main:ajax_register" %}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          username: usernameInput.value.trim(),
          password1: password1Input.value,
          password2: password2Input.value
        })
      });

      const data = await response.json();

      if (data.success) {
        showSuccess(data.message);
        showToast('Success!', data.message, 'success');
        // Redirect to login page after a short delay
        setTimeout(() => {
          window.location.href = data.redirect_url;
        }, 1500);
      } else {
        showError(data.error || 'Registration failed');
      }
    } catch (error) {
      console.error('Registration error:', error);
      showToast('Network Error', 'Please check your connection and try again.', 'error');
    } finally {
      setLoading(false);
    }
  });

  // Real-time password confirmation validation
  password2Input.addEventListener('input', () => {
    if (password1Input.value && password2Input.value && password1Input.value !== password2Input.value) {
      password2Input.setCustomValidity('Passwords do not match');
    } else {
      password2Input.setCustomValidity('');
    }
  });
</script>
{% endblock content %}
